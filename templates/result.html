<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üéóÔ∏è Tumor Classification Result</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --bg0: #070912;
            --bg1: #0b1024;
            --pink: #ff2d8d;
            --pink2: #ff5aa9;
            --blue: #2dd4ff;
            --muted: rgba(255, 255, 255, 0.72);
        }

        body {
            font-family: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background:
                radial-gradient(1100px circle at 15% 0%, rgba(255, 45, 141, 0.22), transparent 60%),
                radial-gradient(900px circle at 85% 0%, rgba(45, 212, 255, 0.16), transparent 55%),
                linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 100%);
            color: #fff;
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 1.25rem;
            backdrop-filter: blur(12px);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.28);
        }

        .glass-card .btn-primary {
            background: linear-gradient(135deg, var(--pink) 0%, #ff3aa0 40%, #ff6bb6 100%);
            border: none;
            box-shadow: 0 16px 40px rgba(255, 45, 141, 0.25);
        }

        .muted {
            color: var(--muted);
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.14);
            margin: 1.1rem 0;
        }

        .section-title {
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .result-text {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .score {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn-outline-light {
            border-color: var(--pink);
            color: var(--pink);
            transition: all 0.3s ease;
        }

        .btn-outline-light:hover {
            background-color: var(--pink);
            color: white;
        }
        
        /* Styles for Chatbot Overlay */
        #chatbot-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }

        .chat-box {
            width: 90%;
            max-width: 500px;
            height: 80%;
            display: flex;
            flex-direction: column;
            background: var(--bg1);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 1rem;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.14);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header-controls {
            display: flex;
            align-items: center;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .chat-input {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.14);
            display: flex;
        }
        
        .message-ai, .message-user {
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            max-width: 85%;
        }

        .message-ai {
            background-color: rgba(45, 212, 255, 0.1); /* Light blue background */
            margin-right: auto;
        }

        .message-user {
            background-color: rgba(255, 45, 141, 0.1); /* Light pink background */
            margin-left: auto;
        }
    </style>
</head>

<body>

    <header class="hero py-5">
        <div class="container">
            <div class="row g-4 justify-content-center">

                <div class="col-lg-6">
                    <div class="glass-card p-4 p-md-5">
                        <h2 class="section-title text-center mb-4">Tumor Classification Result</h2>

                        {% if image_filename %}
                        <div class="text-center mb-4">
                            <img src="{{ url_for('static', filename='uploads/' + image_filename) }}" 
                                 alt="Uploaded Tissue Image" 
                                 class="img-fluid rounded" 
                                 style="max-height: 200px; border: 1px solid rgba(255, 255, 255, 0.2);">
                            <p class="muted mt-2 small">Analysis of file: {{ image_filename }}</p>
                        </div>
                        {% endif %}


                        <div class="result-text">
                            <p class="text-center">The tumor prediction result based on your input:</p>
                        </div>

                        <div class="divider"></div>

                        <div class="result-text">
                            <p class="text-center">Prediction: <span class="score" id="pred-result">{{ result }}</span></p>
                            <p class="text-center">Risk Probability: <span class="score" id="pred-score">{{ score|float * 100 | round(2) }}%</span></p>
                        </div>

                        <div class="d-flex justify-content-center gap-3 mt-4">
                            <button type="button" class="btn btn-outline-light" onclick="openChatbot()">
                                Chat with AI Assistant (XAI)
                            </button>
                        </div>

                        <div class="d-flex justify-content-center gap-3 mt-4">
                            <a class="btn btn-primary" href="/">Back to Home</a>
                            <a class="btn btn-outline-light" href="/mb-form">New Classification</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </header>

    <div id="chatbot-overlay">
        <div class="chat-box">
            <div class="chat-header">
                <h5 class="m-0">AI Assistant (XAI)</h5>
                <div class="chat-header-controls">
                    <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="downloadConversation()">
                        <i class="bi bi-download"></i> Download
                    </button>
                    <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="closeChatbot()"></button>
                </div>
            </div>
            <div class="chat-messages" id="chat-messages">
                </div>
            <div class="chat-input">
                <input type="text" id="user-input" class="form-control me-2" placeholder="Ask about the result (e.g., 'Why is the risk low?')" onkeyup="if(event.key === 'Enter') sendUserMessage()">
                <button type="button" class="btn btn-primary" onclick="sendUserMessage()">Send</button>
            </div>
        </div>
    </div>
    
    <script>
        // 1. DATA RETRIEVAL: Safely parse the data passed from Flask
        const imageFilename = "{{ image_filename }}"; 
        const predictionResult = "{{ result }}";
        const predictionScore = "{{ score }}";
        const shapData = JSON.parse('{{ shap_data | tojson | safe }}'); 
        
        const chatOverlay = document.getElementById('chatbot-overlay');
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');

        // Unique key for session storage, dependent on the current prediction result
        const chatStorageKey = `chat_history_${imageFilename}`; 

        // Array to hold the current conversation state
        let currentChatHistory = [];

        // Function to load conversation history from session storage
        function loadChatHistory() {
            const historyString = sessionStorage.getItem(chatStorageKey);
            if (historyString) {
                try {
                    currentChatHistory = JSON.parse(historyString);
                    return true;
                } catch (e) {
                    console.error("Error parsing chat history:", e);
                    currentChatHistory = [];
                    return false;
                }
            }
            currentChatHistory = [];
            return false;
        }

        // Function to save conversation history to session storage
        function saveChatHistory() {
            sessionStorage.setItem(chatStorageKey, JSON.stringify(currentChatHistory));
        }

        /**
         * Opens the chatbot overlay and handles persistence.
         */
        function openChatbot() {
            chatOverlay.style.display = 'flex';
            chatMessages.innerHTML = ''; // Clear display

            const historyLoaded = loadChatHistory();

            if (historyLoaded) {
                // Render saved history
                currentChatHistory.forEach(msg => {
                    appendMessage(msg.text, msg.sender, false); // Render, but don't save again
                });
            } else {
                // Send initial explanatory message if no history exists
                const initialMessage = `Hello! I'm your XAI Assistant. The prediction is **${predictionResult}** with a risk score of **${(predictionScore * 100).toFixed(2)}%**. 
                                         How can I explain the reasons behind this classification? Try asking: "What are the most important features?"`;
                
                appendMessage(initialMessage, 'ai', true); // Render and save to new history
            }
        }

        /**
         * Closes the chatbot overlay.
         */
        function closeChatbot() {
            chatOverlay.style.display = 'none';
        }

        /**
         * Appends a message to the chat display and optionally saves it.
         * @param {string} text - The message content.
         * @param {string} sender - 'user' or 'ai'.
         * @param {boolean} shouldSave - Whether to save to currentChatHistory.
         */
        function appendMessage(text, sender, shouldSave = true) {
            const msgDiv = document.createElement('div');
            msgDiv.className = sender === 'user' ? 'message-user' : 'message-ai';
            msgDiv.innerHTML = text.replace(/\n/g, '<br>'); 
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            if (shouldSave) {
                currentChatHistory.push({ text: text, sender: sender });
                saveChatHistory();
            }
        }

        /**
         * Downloads the current conversation history as a text file.
         */
        function downloadConversation() {
            if (currentChatHistory.length === 0) {
                alert("No conversation to download.");
                return;
            }

            // Extract only the plain text content for the download
            const header = `--- Tumor Classification Report ---\nPrediction: ${predictionResult}\nScore: ${(predictionScore * 100).toFixed(2)}%\nDate: ${new Date().toLocaleString()}\n---------------------------------------\n\n`;
            
            const conversationText = currentChatHistory.map(msg => 
                `${msg.sender.toUpperCase()}: ${msg.text.replace(/\*\*/g, '')}` // Remove ** for clean text
            ).join('\n\n');

            const fullContent = header + conversationText;

            const blob = new Blob([fullContent], { type: 'text/plain' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `XAI_Conversation_${imageFilename || 'temp'}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /**
         * Sends the user's message to the Flask /chatbot endpoint.
         */
        function sendUserMessage() {
            const userText = userInput.value.trim();
            if (!userText) return;

            // 1. Display and save user message
            appendMessage(userText, 'user', true);
            userInput.value = '';

            // 2. Prepare conversation context for Gemini
            // This maps the stored history into a simple string format for the prompt
            const conversationContext = currentChatHistory.map(msg => 
                `${msg.sender.toUpperCase()}: ${msg.text.replace(/\n/g, ' ')}`
            ).join('\n');
            
            // 3. Send data to Flask via POST
            fetch('/chatbot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_input: userText,
                    result: predictionResult,
                    score: predictionScore,
                    shap_data: shapData,
                    history: conversationContext // Send history for context-aware reply
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 4. Display and save AI response
                appendMessage(data.reply, 'ai', true);
            })
            .catch(error => {
                console.error('Chatbot Error:', error);
                appendMessage("Sorry, I encountered an error communicating with the server. Please check the console for details.", 'ai', true);
            });
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>